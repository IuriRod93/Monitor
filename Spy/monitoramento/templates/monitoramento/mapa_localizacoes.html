{% extends 'base.html' %}
{% block content %}
<style>
    .map-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .map-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .location-list {
        margin-top: 25px;
    }
    .location-item {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
        margin: 15px 0;
        border-radius: 10px;
        border-left: 5px solid #667eea;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .location-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .btn {
        padding: 12px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: bold;
        margin-right: 10px;
        display: inline-block;
        transition: all 0.3s ease;
    }
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        border: none;
    }
    .btn-secondary:hover {
        background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        transform: translateY(-1px);
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: translateY(-1px);
    }
    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 10px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    .stats-number {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
    }
    .stats-label {
        color: #666;
        font-size: 0.9em;
    }
    .location-coords {
        background: rgba(102, 126, 234, 0.1);
        padding: 8px 12px;
        border-radius: 6px;
        font-family: monospace;
        margin: 5px 0;
    }
    .location-time {
        color: #495057;
        font-weight: bold;
        font-size: 1.1em;
    }
    .location-actions {
        margin-top: 10px;
    }
    .location-actions a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
    }
    .location-actions a:hover {
        text-decoration: underline;
    }
</style>

<div class="map-header">
    <h1>üó∫Ô∏è Mapa de Localiza√ß√µes - {{ dispositivo.nome|default:dispositivo.imei }}</h1>
    <p><strong>IMEI:</strong> {{ dispositivo.imei }} | <strong>Modelo:</strong> {{ dispositivo.modelo }} | <strong>Sistema:</strong> {{ dispositivo.sistema_operacional }}</p>
</div>

<div style="margin-bottom: 25px;">
    <a href="{% url 'detalhes_dispositivo' dispositivo.imei %}" class="btn btn-secondary">‚Üê Voltar aos Detalhes</a>
    <a href="https://maps.google.com/maps?q={{ localizacoes.0.latitude|default:'-22.9068' }},{{ localizacoes.0.longitude|default:'-43.1729' }}&z=12" target="_blank" class="btn btn-primary">Ver no Google Maps</a>
</div>

<!-- Estat√≠sticas -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
    <div class="stats-card">
        <div class="stats-number">{{ localizacoes.count }}</div>
        <div class="stats-label">Total de Localiza√ß√µes</div>
    </div>
    <div class="stats-card">
        <div class="stats-number">{% if localizacoes %}{{ localizacoes.0.data_hora|date:"d/m" }}{% else %}--{% endif %}</div>
        <div class="stats-label">√öltima Atualiza√ß√£o</div>
    </div>
    <div class="stats-card">
        <div class="stats-number">{% if localizacoes %}{{ localizacoes.0.data_hora|date:"H:i" }}{% else %}--{% endif %}</div>
        <div class="stats-label">Hor√°rio</div>
    </div>
</div>

<div class="map-container">
    <div id="map"></div>
</div>

<div class="location-list">
    <h3 style="color: #667eea; margin-bottom: 20px;">üìç Hist√≥rico de Localiza√ß√µes</h3>
    {% for loc in localizacoes %}
    <div class="location-item">
        <div class="location-time">{{ loc.data_hora|date:"d/m/Y H:i:s" }}</div>
        <div class="location-coords">
            üìç Lat: {{ loc.latitude|floatformat:6 }} | Lng: {{ loc.longitude|floatformat:6 }}
        </div>
        <div class="location-actions">
            <a href="https://maps.google.com/?q={{ loc.latitude }},{{ loc.longitude }}" target="_blank">üó∫Ô∏è Ver no Google Maps</a> |
            <a href="https://www.google.com/maps/dir//{{ loc.latitude }},{{ loc.longitude }}" target="_blank">üöó Como chegar</a> |
            <a href="https://www.google.com/maps/@{{ loc.latitude }},{{ loc.longitude }},18z" target="_blank">üì∑ Street View</a>
        </div>
    </div>
    {% empty %}
    <div class="stats-card">
        <div style="font-size: 1.2em; color: #666;">Nenhuma localiza√ß√£o registrada para este dispositivo.</div>
        <div style="margin-top: 10px; color: #999;">As localiza√ß√µes aparecer√£o aqui quando o dispositivo enviar dados GPS.</div>
    </div>
    {% endfor %}
</div>

<script>
function initMap() {
    const locations = [
        {% for loc in localizacoes %}
        {
            lat: {{ loc.latitude }},
            lng: {{ loc.longitude }},
            time: "{{ loc.data_hora|date:'d/m/Y H:i:s' }}",
            index: {{ forloop.counter }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    if (locations.length === 0) {
        // Centro padr√£o: S√£o Gon√ßalo, RJ (conforme mencionado pelo usu√°rio)
        const defaultCenter = { lat: -22.8268, lng: -43.0634 }; // S√£o Gon√ßalo, RJ

        const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: defaultCenter,
            mapTypeId: 'roadmap',
            styles: [
                {
                    featureType: 'poi',
                    stylers: [{ visibility: 'off' }]
                }
            ]
        });

        const marker = new google.maps.Marker({
            position: defaultCenter,
            map: map,
            title: 'Localiza√ß√£o Padr√£o - S√£o Gon√ßalo, RJ',
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="18" fill="#667eea" stroke="white" stroke-width="3"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">?</text>
                    </svg>
                `),
                scaledSize: new google.maps.Size(40, 40)
            }
        });

        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div style="text-align: center;">
                    <h4>üìç Localiza√ß√£o Padr√£o</h4>
                    <p><strong>S√£o Gon√ßalo, RJ</strong></p>
                    <p>Latitude: -22.8268<br>Longitude: -43.0634</p>
                    <p style="color: #666; font-size: 0.9em;">Aguardando dados GPS do dispositivo...</p>
                </div>
            `
        });

        marker.addListener('click', () => {
            infoWindow.open(map, marker);
        });

        document.getElementById('map').innerHTML += `
            <div style="position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <strong>üìç Mapa Centralizado em S√£o Gon√ßalo, RJ</strong><br>
                <span style="color: #666; font-size: 0.9em;">Localiza√ß√µes aparecer√£o quando o dispositivo enviar dados GPS.</span>
            </div>
        `;

        return;
    }

    // Centro do mapa na localiza√ß√£o mais recente
    const centerLat = locations[0].lat;
    const centerLng = locations[0].lng;

    const map = new google.maps.Map(document.getElementById('map'), {
        zoom: 15,
        center: { lat: centerLat, lng: centerLng },
        mapTypeId: 'roadmap',
        styles: [
            {
                featureType: 'poi',
                stylers: [{ visibility: 'off' }]
            }
        ]
    });

    // Cores para marcadores diferentes
    const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'];

    // Adicionar marcadores para cada localiza√ß√£o
    locations.forEach((location, index) => {
        const color = colors[index % colors.length];

        const marker = new google.maps.Marker({
            position: { lat: location.lat, lng: location.lng },
            map: map,
            title: `Localiza√ß√£o ${location.index}: ${location.time}`,
            label: {
                text: location.index.toString(),
                color: 'white',
                fontWeight: 'bold'
            },
            icon: {
                url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="3"/>
                        <text x="20" y="26" text-anchor="middle" fill="white" font-family="Arial" font-size="14" font-weight="bold">${location.index}</text>
                    </svg>
                `)}`,
                scaledSize: new google.maps.Size(40, 40)
            }
        });

        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div>
                    <h4 style="margin: 0 0 10px 0; color: ${color};">üìç Localiza√ß√£o ${location.index}</h4>
                    <p style="margin: 5px 0;"><strong>Data/Hora:</strong> ${location.time}</p>
                    <p style="margin: 5px 0;"><strong>Latitude:</strong> ${location.lat.toFixed(6)}</p>
                    <p style="margin: 5px 0;"><strong>Longitude:</strong> ${location.lng.toFixed(6)}</p>
                    <p style="margin: 5px 0;">
                        <a href="https://maps.google.com/?q=${location.lat},${location.lng}" target="_blank" style="color: ${color}; text-decoration: none; font-weight: bold;">üó∫Ô∏è Ver no Google Maps</a>
                    </p>
                </div>
            `
        });

        marker.addListener('click', () => {
            infoWindow.open(map, marker);
        });
    });

    // Desenhar linha conectando as localiza√ß√µes
    if (locations.length > 1) {
        const path = locations.map(loc => ({ lat: loc.lat, lng: loc.lng }));

        const polyline = new google.maps.Polyline({
            path: path,
            geodesic: true,
            strokeColor: '#667eea',
            strokeOpacity: 0.8,
            strokeWeight: 4,
            icons: [{
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 3,
                    strokeColor: '#667eea'
                },
                offset: '100%',
                repeat: '100px'
            }]
        });

        polyline.setMap(map);

        // Ajustar zoom para mostrar todas as localiza√ß√µes
        const bounds = new google.maps.LatLngBounds();
        locations.forEach(loc => {
            bounds.extend(new google.maps.LatLng(loc.lat, loc.lng));
        });
        map.fitBounds(bounds);

        // Adicionar padding
        google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
            if (locations.length > 1) {
                map.setZoom(map.getZoom() - 1);
            }
        });
    }

    // Adicionar controles de zoom customizados
    const zoomControl = document.createElement('div');
    zoomControl.style.position = 'absolute';
    zoomControl.style.top = '10px';
    zoomControl.style.right = '10px';
    zoomControl.style.zIndex = '1000';

    zoomControl.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <button onclick="map.setZoom(map.getZoom() + 1)" style="background: white; border: 1px solid #ccc; border-radius: 4px; padding: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">+</button>
            <button onclick="map.setZoom(map.getZoom() - 1)" style="background: white; border: 1px solid #ccc; border-radius: 4px; padding: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">-</button>
        </div>
    `;

    document.getElementById('map').appendChild(zoomControl);
}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>

<script>
// Fallback caso n√£o tenha API key do Google Maps
window.addEventListener('load', function() {
    setTimeout(function() {
        if (typeof google === 'undefined') {
            document.getElementById('map').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 40px; border-radius: 8px;">
                    <h2 style="margin: 0 0 20px 0;">üó∫Ô∏è Mapa Interativo</h2>
                    <p style="margin: 0 0 20px 0; font-size: 1.1em;">Para visualizar o mapa completo, configure uma API key do Google Maps.</p>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.8;">As coordenadas GPS est√£o listadas abaixo com links diretos.</p>
                    <div style="margin-top: 20px;">
                        <a href="https://maps.google.com/maps?q=-22.8268,-43.0634&z=12" target="_blank" style="background: white; color: #667eea; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: bold; display: inline-block;">üìç Ver S√£o Gon√ßalo no Maps</a>
                    </div>
                </div>
            `;
        }
    }, 2000);
});
</script>

{% endblock %}
